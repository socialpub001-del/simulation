 <!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>QR Send - Pro Ultimate</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.5.4/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --primary: #075e54;
            --secondary: #128c7e;
            --light: #dcf8c6;
            --dark: #1f2c34;
            --bg: #e5ddd5;
            --white: #ffffff;
            --red: #d32f2f;
            --green: #25d366;
        }

        body {
            background: var(--bg);
            height: 100dvh;
            display: flex;
            justify-content: center;
            overflow: hidden;
        }

        .app-container {
            width: 100%;
            max-width: 1000px;
            height: 100%;
            background: var(--white);
            display: flex;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        /* SIDEBAR */
        .sidebar {
            width: 350px;
            border-right: 1px solid #ddd;
            display: flex;
            flex-direction: column;
            background: #f0f2f5;
            transition: transform 0.3s ease;
            z-index: 100;
        }

        .header {
            padding: 15px;
            background: var(--primary);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 60px;
            flex-shrink: 0;
        }

        .status-badge {
            font-size: 12px;
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 8px;
            border-radius: 12px;
        }

        .connect-panel {
            padding: 20px;
            text-align: center;
            flex-grow: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #qrcode {
            background: white;
            padding: 10px;
            display: inline-block;
            border-radius: 8px;
            margin-bottom: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        #qrcode img, #qrcode canvas {
            display: block;
            max-width: 100%;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin: 5px;
            transition: 0.2s;
        }

        .btn-primary {
            background: var(--secondary);
            color: white;
        }

        .btn-outline {
            border: 1px solid var(--secondary);
            color: var(--secondary);
            background: transparent;
        }

        .btn:active {
            transform: scale(0.98);
        }

        /* FILE TRANSFER SECTION */
        .files-panel {
            padding: 15px;
            background: white;
            border-top: 1px solid #ddd;
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            min-height: 0;
            max-height: 50%;
        }

        .files-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            font-weight: bold;
            align-items: center;
            flex-shrink: 0;
        }

        /* --- 3D MAGIC FOLDER BUTTON (SIDEBAR VERSION) --- */
        .magic-btn-small {
            position: relative;
            padding: 8px 15px;
            border-radius: 8px;
            background: #ffffff;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: bold;
            font-size: 13px;
            color: #333;
            transform-style: preserve-3d;
            transition: transform 0.1s;
            z-index: 1;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .magic-btn-small:active {
            transform: scale(0.95);
        }

        /* Multi-Color Glow Animation */
        .magic-btn-small::before {
            content: "";
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, #4285f4, #db4437, #f4b400, #0f9d58);
            z-index: -1;
            border-radius: 10px;
            filter: blur(6px);
            opacity: 0.8;
            animation: glowing 3s linear infinite;
        }

        .magic-btn-small::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            border-radius: 8px;
            z-index: -1;
        }

        @keyframes glowing {
            0% {
                filter: blur(5px);
                opacity: 0.6;
            }

            50% {
                filter: blur(8px);
                opacity: 0.9;
            }

            100% {
                filter: blur(5px);
                opacity: 0.6;
            }
        }

        /* ------------------------------------------------ */

        /* NEW FIREBASE GLOW STYLE FOR MOBILE FOLDER ICON */
        .firebase-glow-btn {
            background: #ffffff;
            border: 2px solid #ffffff;
            border-radius: 12px; /* 2D Box Look */
            width: 42px;
            height: 42px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
            margin-right: 10px;
            
            /* The Google Firebase Glow */
            box-shadow: 0 0 10px rgba(255, 193, 7, 0.6), 
                        0 0 20px rgba(255, 87, 34, 0.4);
            animation: firebasePulse 2s infinite ease-in-out;
            transition: transform 0.2s;
        }

        .firebase-glow-btn:active {
            transform: scale(0.92);
        }

        @keyframes firebasePulse {
            0% { box-shadow: 0 0 8px rgba(255, 193, 7, 0.5); }
            50% { box-shadow: 0 0 18px rgba(255, 160, 0, 0.8), 0 0 12px rgba(255, 255, 255, 0.6); }
            100% { box-shadow: 0 0 8px rgba(255, 193, 7, 0.5); }
        }

        /* ------------------------------------------------ */

        #file-input {
            display: none;
        }

        #transfer-list {
            flex-grow: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding-right: 5px;
            min-height: 0;
        }

        .transfer-item {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #eee;
            position: relative;
            font-size: 13px;
            flex-shrink: 0;
        }

        .t-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .t-name {
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 160px;
        }

        .t-bar-bg {
            height: 6px;
            background: #ddd;
            border-radius: 3px;
            overflow: hidden;
        }

        .t-bar-fill {
            height: 100%;
            background: var(--green);
            width: 0%;
            transition: width 0.2s;
        }

        .t-meta {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: #666;
            margin-top: 4px;
        }

        .btn-cancel {
            background: transparent;
            color: var(--red);
            border: none;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }

        /* CHAT SECTION */
        .chat-area {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');
            background-color: #e5ddd5;
            position: relative;
        }

        .chat-header {
            padding: 10px 15px;
            background: #f0f2f5;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 60px;
            flex-shrink: 0;
        }

        .chat-user {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Sound Toggle Button (Replaces Avatar) */
        .sound-toggle-btn {
            width: 40px;
            height: 40px;
            background: #ffffff;
            border: 1px solid #ddd;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            transition: 0.2s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .sound-toggle-btn:active {
            transform: scale(0.9);
        }

        .sound-mode-ring {
            color: var(--primary);
        }

        .sound-mode-vibrate {
            color: #ff9800;
        }

        .sound-mode-silent {
            color: #999;
            text-decoration: line-through;
        }

        .chat-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        /* UPDATED: WHATSAPP STYLE ICONS */
        .icon-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--primary);
            padding: 8px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .icon-btn:hover {
            background: rgba(0, 0, 0, 0.05);
        }

        .icon-btn svg {
            width: 24px;
            height: 24px;
            fill: currentColor;
        }

        .messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            -webkit-overflow-scrolling: touch;
        }

        .msg {
            max-width: 75%;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 14px;
            position: relative;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            word-break: break-word;
        }

        .msg.sent {
            align-self: flex-end;
            background: var(--light);
            border-top-right-radius: 0;
        }

        .msg.received {
            align-self: flex-start;
            background: white;
            border-top-left-radius: 0;
        }

        .msg-time {
            font-size: 10px;
            color: #999;
            float: right;
            margin-top: 5px;
            margin-left: 10px;
            display: flex;
            align-items: center;
            gap: 3px;
        }

        .double-tick {
            color: #4fc3f7;
            font-weight: bold;
            font-size: 10px;
        }

        .msg img {
            max-width: 100%;
            border-radius: 6px;
            cursor: pointer;
            display: block;
        }

        .reply-bar {
            background: rgba(255, 255, 255, 0.9);
            padding: 5px 15px;
            border-left: 5px solid var(--secondary);
            display: none;
            justify-content: space-between;
            font-size: 12px;
            color: #555;
            flex-shrink: 0;
        }

        .msg-reply-preview {
            background: rgba(0, 0, 0, 0.05);
            padding: 4px;
            border-left: 3px solid var(--secondary);
            margin-bottom: 4px;
            border-radius: 4px;
            font-size: 11px;
        }

        .reply-btn {
            position: absolute;
            top: 5px;
            right: -25px;
            background: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .msg:hover .reply-btn {
            display: flex;
        }

        /* FIXED INPUT AREA */
        .input-area {
            padding: 10px;
            background: #f0f2f5;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
            width: 100%;
            box-sizing: border-box;
        }

        #msg-input {
            flex-grow: 1;
            padding: 12px;
            border: none;
            border-radius: 20px;
            outline: none;
            font-size: 15px;
            min-width: 0;
        }

        .send-btn {
            background: var(--primary);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            margin-right: 2px;
        }

        .typing-indicator {
            font-size: 11px;
            color: var(--secondary);
            font-weight: bold;
            animation: flash 1.5s infinite;
            display: none;
        }

        @keyframes flash {
            0% {
                opacity: 0.3;
            }

            50% {
                opacity: 1;
            }

            100% {
                opacity: 0.3;
            }
        }

        .mobile-only {
            display: none;
        }

        /* CALL OVERLAYS */
        .fullscreen-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2000;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .call-card {
            background: #1f2c34;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            width: 300px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .call-avatar-lg {
            width: 100px;
            height: 100px;
            background: #ddd;
            border-radius: 50%;
            margin: 0 auto 20px;
            overflow: hidden;
        }

        .call-actions {
            display: flex;
            justify-content: space-around;
            margin-top: 40px;
        }

        .call-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            transition: transform 0.2s;
        }

        .btn-accept {
            background: var(--green);
            color: white;
            animation: pulse 1.5s infinite;
        }

        .btn-reject {
            background: var(--red);
            color: white;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(37, 211, 102, 0.7);
            }

            70% {
                box-shadow: 0 0 0 15px rgba(37, 211, 102, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(37, 211, 102, 0);
            }
        }

        .active-call-ui {
            width: 100%;
            height: 100%;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        #remote-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        #local-video {
            position: absolute;
            bottom: 100px;
            right: 20px;
            width: 120px;
            height: 160px;
            background: #333;
            border-radius: 10px;
            border: 2px solid white;
            object-fit: cover;
        }

        .call-controls-bar {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.6);
            padding: 15px 30px;
            border-radius: 30px;
            display: flex;
            gap: 20px;
        }

        .control-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .control-btn.off {
            background: white;
            color: black;
        }

        .btn-hangup {
            background: var(--red);
        }

        /* Connection Lock */
        .connection-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            backdrop-filter: blur(10px);
            flex-direction: column;
        }

        .lock-svg {
            width: 120px;
            height: 120px;
        }

        .lock-body {
            fill: #4285f4;
            animation: lockBody 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        .lock-shackle {
            fill: none;
            stroke: #4285f4;
            stroke-width: 5;
            stroke-linecap: round;
            transform-origin: 50% 35%;
            animation: lockShackle 0.6s ease forwards 0.4s;
        }

        .checkmark {
            fill: none;
            stroke: #34a853;
            stroke-width: 5;
            stroke-linecap: round;
            stroke-linejoin: round;
            stroke-dasharray: 100;
            stroke-dashoffset: 100;
            animation: checkDraw 0.5s ease forwards 1s;
        }

        @keyframes lockBody {
            from {
                transform: scale(0.5);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        @keyframes lockShackle {
            0% {
                transform: translateY(-15px);
                opacity: 0;
            }

            100% {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes checkDraw {
            to {
                stroke-dashoffset: 0;
            }
        }

        /* PERMISSION GUIDE MODAL */
        .perm-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 9999;
            display: none;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .perm-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            max-width: 350px;
            width: 100%;
            text-align: center;
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .perm-icon {
            font-size: 40px;
            margin-bottom: 15px;
        }

        .perm-step {
            display: flex;
            align-items: center;
            gap: 10px;
            text-align: left;
            margin-bottom: 10px;
            font-size: 14px;
            color: #333;
            background: #f5f5f5;
            padding: 10px;
            border-radius: 8px;
        }

        .perm-step span {
            background: var(--primary);
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            flex-shrink: 0;
        }

        .btn-perm-ok {
            background: var(--primary);
            color: white;
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            margin-top: 15px;
            cursor: pointer;
            font-weight: bold;
        }

        /* Modals */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 3000;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .modal img {
            max-width: 95%;
            max-height: 90%;
            border-radius: 8px;
            object-fit: contain;
        }

        .modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            color: white;
            font-size: 30px;
            cursor: pointer;
            background: rgba(0, 0, 0, 0.5);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-dl {
            position: absolute;
            bottom: 30px;
            background: white;
            color: black;
            padding: 10px 20px;
            border-radius: 20px;
            text-decoration: none;
            font-weight: bold;
        }

        #scanner-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: black;
            z-index: 4000;
            display: none;
            flex-direction: column;
        }

        #qr-reader {
            flex-grow: 1;
        }

        .scanner-close {
            position: absolute;
            top: 20px;
            right: 20px;
            color: white;
            z-index: 4001;
            font-size: 30px;
            cursor: pointer;
        }

        /* MOBILE RESPONSIVE FIXES */
        @media (max-width: 768px) {
            .app-container {
                flex-direction: column;
                width: 100%;
            }

            .sidebar {
                width: 100%;
                height: 100%;
                position: absolute;
                top: 0;
                left: 0;
                transform: translateX(0);
            }

            .sidebar.hidden {
                transform: translateX(-100%);
            }

            .chat-area {
                width: 100%;
                height: 100%;
                position: absolute;
                top: 0;
                left: 0;
                z-index: 50;
            }

            .mobile-only {
                display: inline-block;
            }

            .files-panel {
                max-height: none;
            }

            .header {
                padding-right: 10px;
            }

            .btn-close-sidebar {
                background: none;
                border: none;
                color: white;
                font-size: 20px;
                cursor: pointer;
                margin-right: 10px;
            }

            #local-video {
                width: 90px;
                height: 120px;
                bottom: 120px;
                right: 10px;
            }

            .input-area {
                padding: 8px;
                gap: 6px;
            }
        }
    </style>
</head>

<body>
    <!-- RINGTONE AUDIO -->
    <!-- MODIFIED: Updated with a softer, pleasant chime ringtone -->
    <audio id="ringtone" loop src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

    <div class="app-container">
        <!-- SIDEBAR -->
        <div class="sidebar" id="sidebar">
            <div class="header">
                <div style="display:flex; align-items:center;">
                    <button class="mobile-only btn-close-sidebar" onclick="toggleSidebar()">‚Üê</button>
                    <h2>QR Send</h2>
                </div>
                <span id="status-badge" class="status-badge">Disconnected</span>
            </div>

            <div class="connect-panel" id="connect-panel">
                <div id="qrcode"></div>
                <p id="connect-msg" style="color:#666; margin-bottom:10px;">Scan to connect devices</p>
                <div style="display:flex; justify-content:center; flex-wrap:wrap;">
                    <button class="btn btn-outline" onclick="shareQRCode()">üîó Share QR</button>
                    <button class="btn btn-primary" onclick="startScanner()">üì∑ Scan QR</button>
                </div>
            </div>

            <div class="files-panel" id="files-panel">
                <div class="files-header">
                    <span>File Transfer</span>
                    <!-- UPDATED: 3D MAGIC FOLDER BUTTON IN SIDEBAR -->
                    <button class="magic-btn-small" onclick="document.getElementById('file-input').click()">
                        <span style="font-size:16px;">üìÇ</span> Add File
                    </button>
                </div>
                <input type="file" id="file-input" multiple>
                <div id="transfer-list"></div>
            </div>
        </div>

        <!-- CHAT AREA -->
        <div class="chat-area" id="chat-area">
            <div class="chat-header">
                <div class="chat-user">
                    <!-- 
                        MODIFIED: REPLACED OLD SIMPLE BUTTON WITH NEW GLOWING FIREBASE STYLE BUTTON 
                        Replaced "icon-btn" with "firebase-glow-btn"
                    -->
                    <button class="firebase-glow-btn mobile-only" onclick="toggleSidebar()">üìÅ</button>

                    <!-- UPDATED: SOUND TOGGLE BUTTON (Replaces Avatar) -->
                    <div class="sound-toggle-btn" id="sound-toggle" onclick="toggleSoundMode()">
                        üîî
                    </div>

                    <div>
                        <div style="font-weight:bold;">Peer</div>
                        <div style="font-size:11px; color:#666;" id="connection-status">Waiting...</div>
                        <div class="typing-indicator" id="typing-indicator">Typing...</div>
                    </div>
                </div>
                <!-- 
                    MODIFIED SECTION: REAL WHATSAPP ICONS (SVG)
                    Replaced emojis üìû and üìπ with SVG paths
                -->
                <div class="chat-actions">
                    <!-- Video Call Icon -->
                    <button class="icon-btn" onclick="initCall(true)" title="Video Call">
                        <svg viewBox="0 0 24 24" preserveAspectRatio="xMidYMid meet" version="1.1" x="0px" y="0px">
                            <path d="M21.526,8.149C21.231,7.967,20.862,7.951,20.553,8.105l-3.266,1.634V6.5c0-1.654-1.346-3-3-3H4.5c-1.654,0-3,1.346-3,3 v11c0,1.654,1.346,3,3,3h9.787c1.654,0,3-1.346,3-3v-3.24l3.266,1.634c0.129,0.065,0.27,0.096,0.411,0.096 c0.187,0,0.373-0.055,0.534-0.16c0.295-0.191,0.472-0.522,0.472-0.875V9.024C21.999,8.671,21.821,8.34,21.526,8.149z"></path>
                        </svg>
                    </button>
                    <!-- Audio Call Icon -->
                    <button class="icon-btn" onclick="initCall(false)" title="Voice Call">
                        <svg viewBox="0 0 24 24" preserveAspectRatio="xMidYMid meet" version="1.1" x="0px" y="0px">
                            <path d="M19.376,12.416L19.376,12.416c-0.865-0.421-2.091-0.908-3.52-1.328c-0.85-0.25-1.748,0.021-2.22,0.672 l-1.074,1.482c-0.198,0.273-0.575,0.369-0.876,0.219c-1.722-0.854-3.593-2.671-4.48-4.321c-0.158-0.294-0.076-0.658,0.188-0.862 l1.521-1.171c0.613-0.472,0.916-1.329,0.73-2.158c-0.347-1.547-0.741-2.887-1.096-3.811C8.254,0.349,7.469-0.163,6.583,0.038 L4.538,0.506C3.013,0.854,1.836,2.259,2.022,3.823c0.353,2.964,1.875,7.311,5.659,11.233c4.156,4.308,8.969,5.772,11.956,5.918 c1.564,0.076,2.915-1.157,3.167-2.695l0.36-2.193C23.36,15.155,22.759,14.062,19.376,12.416z"></path>
                        </svg>
                    </button>
                </div>
            </div>

            <div class="messages" id="messages"></div>

            <div class="reply-bar" id="reply-bar">
                <div>
                    <div style="color:var(--primary); font-weight:bold; font-size:10px;">Replying to...</div>
                    <div id="reply-text-preview"></div>
                </div>
                <button onclick="cancelReply()" style="border:none; background:none; font-size:16px;">‚úï</button>
            </div>

            <div class="input-area">
                <!-- Removed floating mobile magic button since it's now in sidebar/header accessibility -->

                <!-- Use this for image upload -->
                <button class="icon-btn" onclick="document.getElementById('img-input').click()">üì∑</button>

                <input type="file" id="img-input" accept="image/*" style="display:none">
                <input type="text" id="msg-input" placeholder="Type a message...">
                <button class="send-btn" onmousedown="event.preventDefault()" onclick="sendText()">‚û§</button>
            </div>
        </div>
    </div>

    <!-- OVERLAYS -->

    <!-- CONNECTION LOCK OVERLAY -->
    <div class="connection-overlay" id="connection-overlay">
        <div class="lock-animation">
            <svg class="lock-svg" viewBox="0 0 100 100">
                <path class="lock-shackle" d="M35 45 V35 C35 25 40 20 50 20 C60 20 65 25 65 35 V45" />
                <rect class="lock-body" x="30" y="45" width="40" height="35" rx="5" />
                <polyline class="checkmark" points="40,62 47,69 62,54" />
            </svg>
            <p style="color: white; font-weight: 600; margin-top: 15px; font-size: 18px;">End-to-End Encrypted</p>
        </div>
    </div>

    <!-- PERMISSION GUIDE MODAL -->
    <div class="perm-modal" id="perm-modal">
        <div class="perm-card">
            <div class="perm-icon">üîí</div>
            <h3>Permission Blocked</h3>
            <p style="color:#666; font-size:13px; margin-bottom:15px;">To make calls, please enable microphone/camera
                access.</p>

            <div class="perm-step">
                <span>1</span>
                <div>Tap the <b>Lock Icon</b> (üîí) or <b>Settings</b> in the URL bar.</div>
            </div>
            <div class="perm-step">
                <span>2</span>
                <div>Select <b>Permissions</b> or <b>Site Settings</b>.</div>
            </div>
            <div class="perm-step">
                <span>3</span>
                <div>Set Camera & Microphone to <b>Allow</b> or <b>Ask</b>.</div>
            </div>

            <button class="btn-perm-ok" onclick="document.getElementById('perm-modal').style.display='none'">Okay, I'll
                do it</button>
        </div>
    </div>

    <div class="fullscreen-overlay" id="incoming-call-ui">
        <div class="call-card">
            <div class="call-avatar-lg"><img src="https://cdn-icons-png.flaticon.com/512/149/149071.png" width="100%">
            </div>
            <h2 id="incoming-call-type">Incoming Call...</h2>
            <p style="color:#aaa; margin-top:10px;">Peer is calling you</p>
            <div class="call-actions">
                <button class="call-btn btn-reject" onclick="rejectCall()">‚úñ</button>
                <button class="call-btn btn-accept" onclick="answerCall()">‚úî</button>
            </div>
        </div>
    </div>

    <div class="fullscreen-overlay" id="active-call-ui">
        <div class="active-call-ui">
            <video id="remote-video" autoplay playsinline></video>
            <video id="local-video" autoplay playsinline muted></video>
            <div class="call-controls-bar">
                <button class="control-btn" id="btn-mute" onclick="toggleMic()">üé§</button>
                <button class="control-btn btn-hangup" onclick="endCall()">üìû</button>
                <button class="control-btn" id="btn-cam" onclick="toggleCam()">üì∑</button>
            </div>
        </div>
    </div>

    <div class="modal" id="img-modal">
        <div class="modal-close" onclick="closeModal()">‚úï</div>
        <img id="modal-img" src="">
        <a id="modal-dl" href="#" class="modal-dl" download>Download</a>
    </div>

    <div id="scanner-overlay">
        <div class="scanner-close" onclick="stopScanner()">‚úï</div>
        <div id="qr-reader"></div>
    </div>

    <script>
        let peer, conn, myId, isHost;
        let activeCall = null, localStream = null;
        let replyContext = null;
        let fileQueue = [], activeTransfer = null, isTransferring = false;
        let typingTimeout;
        let callMode = 'ring'; // ring, vibrate, silent
        let vibrateInterval;

        document.addEventListener('DOMContentLoaded', () => {
            // Check if mobile to show/hide elements
            if (window.innerWidth < 768) {
                const hiddenEl = document.querySelector('.mobile-hidden');
                if (hiddenEl) hiddenEl.style.display = 'none';
            }

            window.addEventListener('beforeunload', (e) => {
                if (!isHost) { history.replaceState(null, null, window.location.pathname); }
            });
            initApp();

            const msgInput = document.getElementById('msg-input');

            // Typing Listener
            msgInput.addEventListener('input', () => {
                if (conn && conn.open) {
                    conn.send({ type: 'typing', isTyping: true });
                    clearTimeout(typingTimeout);
                    typingTimeout = setTimeout(() => {
                        if (conn && conn.open) conn.send({ type: 'typing', isTyping: false });
                    }, 1000);
                }
            });

            // ENTER KEY TO SEND
            msgInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendText();
                }
            });

            // Image Listener
            document.getElementById('img-input').addEventListener('change', function () {
                const file = this.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = function (e) {
                    const msgId = Date.now();
                    const base64 = e.target.result;
                    if (conn && conn.open) conn.send({ type: 'image', content: base64, id: msgId });
                    addImage(base64, 'sent', msgId);
                };
                reader.readAsDataURL(file);
                this.value = '';
            });
        });

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('hidden');
        }

        // SOUND MODE TOGGLE LOGIC
        function toggleSoundMode() {
            const btn = document.getElementById('sound-toggle');
            if (callMode === 'ring') {
                callMode = 'vibrate';
                btn.innerText = 'üì≥';
                btn.className = 'sound-toggle-btn sound-mode-vibrate';
            } else if (callMode === 'vibrate') {
                callMode = 'silent';
                btn.innerText = 'üîï';
                btn.className = 'sound-toggle-btn sound-mode-silent';
            } else {
                callMode = 'ring';
                btn.innerText = 'üîî';
                btn.className = 'sound-toggle-btn sound-mode-ring';
            }
        }

        function playCallAlert() {
            if (callMode === 'silent') return;

            if (callMode === 'ring') {
                const audio = document.getElementById('ringtone');
                audio.currentTime = 0;
                audio.play().catch(e => console.log("Audio play failed (interaction required)", e));
            }

            if (callMode === 'ring' || callMode === 'vibrate') {
                if (navigator.vibrate) {
                    vibrateInterval = setInterval(() => {
                        navigator.vibrate([500, 200, 500]);
                    }, 1500);
                }
            }
        }

        function stopCallAlert() {
            const audio = document.getElementById('ringtone');
            audio.pause();
            audio.currentTime = 0;
            if (vibrateInterval) clearInterval(vibrateInterval);
            if (navigator.vibrate) navigator.vibrate(0);
        }

        function initApp() {
            const hash = window.location.hash.substring(1);
            isHost = !hash;

            // FIX: Enhanced STUN server list (Crucial for Mobile-to-Mobile)
            const peerConfig = {
                debug: 2,
                config: {
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:global.stun.twilio.com:3478' },
                        { urls: 'stun:stun.voip.blackberry.com:3478' },
                        { urls: 'stun:stun.mit.edu:8000' },
                        { urls: 'stun:stun.sipgate.net:3478' }
                    ]
                }
            };

            peer = new Peer(undefined, peerConfig);

            peer.on('open', (id) => {
                myId = id;
                if (isHost) {
                    new QRCode(document.getElementById('qrcode'), { text: window.location.href + '#' + id, width: 180, height: 180 });
                } else {
                    document.getElementById('connect-panel').style.display = 'none';
                    document.getElementById('connection-status').innerText = 'Connecting...';
                    connectToPeer(hash);
                    if (window.innerWidth < 768) document.getElementById('sidebar').classList.add('hidden');
                }
            });

            peer.on('connection', (c) => setupConnection(c));

            peer.on('call', (call) => {
                document.getElementById('incoming-call-ui').style.display = 'flex';
                document.getElementById('incoming-call-type').innerText = call.metadata?.type === 'video' ? 'Incoming Video Call...' : 'Incoming Voice Call...';
                window.pendingCall = call;
                // TRIGGER SOUND/VIBRATION
                playCallAlert();
            });

            // FIX: Better Error Handling
            peer.on('error', (err) => {
                console.error(err);
                if (!isHost && (err.type === 'peer-unavailable' || err.type === 'network')) {
                    alert("Connection failed. Please try scanning again.");
                    window.location.hash = ''; window.location.reload();
                }
            });
        }

        function connectToPeer(id) {
            // FIX: Wait slightly to ensure peer is ready
            setTimeout(() => {
                setupConnection(peer.connect(id, { reliable: true }));
            }, 1000);
        }

        function setupConnection(c) {
            conn = c;
            conn.on('open', () => {
                const overlay = document.getElementById('connection-overlay');
                overlay.style.display = 'flex';
                setTimeout(() => {
                    overlay.style.display = 'none';
                }, 2500);

                document.getElementById('status-badge').innerText = 'Connected';
                document.getElementById('status-badge').style.background = 'var(--green)';
                document.getElementById('connect-panel').style.display = 'none';
                document.getElementById('connection-status').innerText = 'Online';
                if (window.innerWidth < 768) document.getElementById('sidebar').classList.add('hidden');
            });
            conn.on('data', handleData);
            conn.on('close', () => { alert('Disconnected'); window.location.hash = ''; window.location.reload(); });
            conn.on('error', (err) => console.error("Conn Error", err));
        }

        function handleData(data) {
            switch (data.type) {
                case 'text': addMessage(data.content, 'received', data.reply); conn.send({ type: 'ack', id: data.id }); break;
                case 'image': addImage(data.content, 'received', data.id); conn.send({ type: 'ack', id: data.id }); break;
                case 'typing':
                    const ind = document.getElementById('typing-indicator');
                    ind.style.display = data.isTyping ? 'block' : 'none';
                    break;
                case 'ack': markRead(data.id); break;
                case 'dl-notify': markDownloaded(data.id); break;
                case 'file-meta': startReceivingFile(data); break;
                case 'file-chunk': processFileChunk(data); break;
                case 'file-cancel': handleFileCancel(data.fileId); break;
                // MODIFIED: Added handler for rejected calls
                case 'call-rejected': 
                    alert('Call Rejected'); 
                    endCallUI(); 
                    break;
                case 'call-end': endCallUI(); break;
            }
        }

        async function shareQRCode() {
            // FIX: Handle both Canvas and Image rendering from qrcode.js
            const canvas = document.querySelector('#qrcode canvas');
            const img = document.querySelector('#qrcode img');
            let url;

            if (canvas) {
                url = canvas.toDataURL();
            } else if (img) {
                url = img.src;
            } else {
                alert("QR Code not generated yet. Please wait.");
                return;
            }

            try {
                const blob = await (await fetch(url)).blob();
                const file = new File([blob], "qr.png", { type: "image/png" });
                if (navigator.share) {
                    navigator.share({ files: [file], url: window.location.href + '#' + myId })
                        .catch(err => console.log("Share cancelled"));
                } else {
                    alert("Web Share API not supported on this browser.");
                }
            } catch (e) {
                console.error("Error sharing QR", e);
            }
        }

        // Chat Logic
        function sendText() {
            const input = document.getElementById('msg-input');
            const val = input.value.trim();
            if (!val) return;
            
            if (!conn || !conn.open) {
                alert("Not connected to a peer!");
                return;
            }
            
            const id = Date.now();
            conn.send({ type: 'text', content: val, id: id, reply: replyContext });
            addMessage(val, 'sent', replyContext, id);
            input.value = '';
            cancelReply();
            input.focus();
        }

        function addMessage(text, type, reply, id) {
            const div = document.createElement('div');
            div.className = `msg ${type}`; div.id = `msg-${id}`;
            let html = reply ? `<div class="msg-reply-preview">${reply.text.substring(0, 50)}...</div>` : '';
            html += `${text}<div class="msg-time">${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })} ${type === 'sent' ? '<span class="double-tick">‚úì</span>' : ''}</div><div class="reply-btn" onclick="setReply('${text.replace(/'/g, "\\'")}')">‚Ü©</div>`;
            div.innerHTML = html;
            document.getElementById('messages').appendChild(div);
            scrollToBottom();
        }

        function addImage(src, type, id) {
            const div = document.createElement('div');
            div.className = `msg ${type}`; div.id = `msg-${id}`;
            div.innerHTML = `<img src="${src}" onclick="openModal(this.src, '${type}', ${id})"><div class="msg-time">${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })} ${type === 'sent' ? '<span class="double-tick">‚úì</span>' : ''}</div>${type === 'sent' ? '<div class="download-indicator" style="font-size:10px; display:none;">Downloaded by peer</div>' : ''}`;
            document.getElementById('messages').appendChild(div);
            scrollToBottom();
        }

        // File Transfer
        document.getElementById('file-input').onchange = function () {
            for (let f of this.files) {
                const id = Date.now() + Math.random().toString(36).substr(2, 5);
                fileQueue.push({ file: f, id: id });
                createFileUI(id, f.name, 'Sending');
            }
            processFileQueue(); this.value = '';
        };

        function createFileUI(id, name, type) {
            const div = document.createElement('div');
            div.className = 'transfer-item'; div.id = `file-${id}`;
            div.innerHTML = `<div class="t-info"><span class="t-name">${name}</span><button class="btn-cancel" onclick="cancelTransfer('${id}', '${type}')">‚úï</button></div><div class="t-bar-bg"><div class="t-bar-fill" id="bar-${id}"></div></div><div class="t-meta"><span id="prog-${id}">0%</span><span id="eta-${id}">Calculating...</span></div>`;
            document.getElementById('transfer-list').prepend(div);
        }

        function processFileQueue() {
            if (isTransferring || fileQueue.length === 0) return;
            if (!conn || !conn.open) return; // Safety check

            const item = fileQueue.shift();
            activeTransfer = item; isTransferring = true;
            try {
                conn.send({ type: 'file-meta', fileId: item.id, name: item.file.name, size: item.file.size });

                const reader = new FileReader();
                let offset = 0; let start = Date.now();
                reader.onload = (e) => {
                    if (!activeTransfer) return;
                    // Check connection again before sending chunk
                    if (conn && conn.open) {
                        conn.send({ type: 'file-chunk', fileId: item.id, data: e.target.result });
                        offset += e.target.result.byteLength;
                        updateProgress(item.id, offset, item.file.size, start);
                        if (offset < item.file.size) readNext();
                        else { isTransferring = false; setTimeout(processFileQueue, 50); }
                    } else {
                         isTransferring = false;
                    }
                };
                const readNext = () => reader.readAsArrayBuffer(item.file.slice(offset, offset + 16384));
                readNext();
            } catch(e) {
                console.error("Transfer failed", e);
                isTransferring = false;
            }
        }

        let receiving = {};
        function startReceivingFile(meta) {
            receiving[meta.fileId] = { name: meta.name, size: meta.size, received: 0, buffer: [], start: Date.now() };
            createFileUI(meta.fileId, meta.name, 'Receiving');
        }
        function processFileChunk(data) {
            const f = receiving[data.fileId];
            if (!f) return;
            f.buffer.push(data.data); f.received += data.data.byteLength;
            updateProgress(data.fileId, f.received, f.size, f.start);
            if (f.received >= f.size) {
                const url = URL.createObjectURL(new Blob(f.buffer));
                const a = document.createElement('a'); a.href = url; a.download = f.name;
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
                delete receiving[data.fileId];
                document.getElementById(`eta-${data.fileId}`).innerText = 'Done';
            }
        }

        function updateProgress(id, cur, tot, start) {
            const pct = Math.round((cur / tot) * 100);
            const bar = document.getElementById(`bar-${id}`);
            const txt = document.getElementById(`prog-${id}`);
            const eta = document.getElementById(`eta-${id}`);
            if (bar) bar.style.width = pct + '%';
            if (txt) txt.innerText = pct + '%';

            const elapsed = (Date.now() - start) / 1000;
            const rate = cur / elapsed;
            const left = (tot - cur) / rate;

            if (eta && isFinite(left)) {
                eta.innerText = left < 1 ? 'Done' : formatTime(left) + ' left';
            }
        }

        function formatTime(seconds) {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = Math.floor(seconds % 60);
            return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        }

        function cancelTransfer(id, type) {
            document.getElementById(`file-${id}`).remove();
            if (conn && conn.open) conn.send({ type: 'file-cancel', fileId: id });
            if (type === 'Sending') {
                if (activeTransfer?.id === id) { activeTransfer = null; isTransferring = false; processFileQueue(); }
                else fileQueue = fileQueue.filter(i => i.id !== id);
            } else delete receiving[id];
        }
        function handleFileCancel(id) {
            const el = document.getElementById(`file-${id}`);
            if (el) el.innerHTML = '<span style="color:red">Cancelled by peer</span>';
            if (activeTransfer?.id === id) { activeTransfer = null; isTransferring = false; processFileQueue(); }
            delete receiving[id];
        }

        function scrollToBottom() { document.getElementById('messages').scrollTop = 1000000; }
        function markRead(id) { const el = document.querySelector(`#msg-${id} .double-tick`); if (el) el.innerText = '‚úì‚úì'; }
        function markDownloaded(id) { const el = document.querySelector(`#msg-${id} .download-indicator`); if (el) el.style.display = 'block'; }
        function openModal(src, type, id) {
            document.getElementById('img-modal').style.display = 'flex'; document.getElementById('modal-img').src = src;
            const dl = document.getElementById('modal-dl');
            if (type === 'received') { dl.style.display = 'block'; dl.href = src; dl.onclick = () => conn.send({ type: 'dl-notify', id: id }); }
            else dl.style.display = 'none';
        }
        function closeModal() { document.getElementById('img-modal').style.display = 'none'; }
        function setReply(t) { replyContext = { text: t }; document.getElementById('reply-bar').style.display = 'flex'; document.getElementById('reply-text-preview').innerText = t.substring(0, 50) + '...'; }
        function cancelReply() { replyContext = null; document.getElementById('reply-bar').style.display = 'none'; }

        // HD Media Constraints
        const mediaConstraints = {
            audio: { echoCancellation: true, noiseSuppression: true, autoGainControl: true },
            video: { width: { ideal: 1280 }, height: { ideal: 720 }, frameRate: { ideal: 30 }, facingMode: "user" }
        };

        // FIX: Permission Handling Logic
        function checkMediaPermissions(vid) {
            return new Promise((resolve, reject) => {
                const constraints = vid ? mediaConstraints : { audio: true, video: false };
                
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    alert("Your browser does not support calling. Please use a modern browser on HTTPS.");
                    reject("Not supported");
                    return;
                }

                navigator.mediaDevices.getUserMedia(constraints)
                .then(stream => {
                    resolve(stream);
                })
                .catch(err => {
                    // If permission denied, showing the Modal Guide
                    if(err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                        document.getElementById('perm-modal').style.display = 'flex';
                    } else {
                        alert("Error accessing media devices: " + err.message);
                    }
                    reject(err);
                });
            });
        }

        function initCall(vid) {
            checkMediaPermissions(vid).then(s => {
                localStream = s;
                document.getElementById('active-call-ui').style.display = 'flex';
                document.getElementById('local-video').srcObject = s;
                const call = peer.call(conn.peer, s, { metadata: { type: vid ? 'video' : 'audio' } });
                handleCall(call);
            }).catch(e => console.log("Call init aborted"));
        }

        function answerCall() {
            stopCallAlert(); // STOP RINGTONE
            document.getElementById('incoming-call-ui').style.display = 'none';
            const vid = window.pendingCall.metadata.type === 'video';
            
            checkMediaPermissions(vid).then(s => {
                localStream = s;
                document.getElementById('active-call-ui').style.display = 'flex';
                document.getElementById('local-video').srcObject = s;
                window.pendingCall.answer(s);
                handleCall(window.pendingCall);
            }).catch(e => console.log("Call answer aborted"));
        }

        function handleCall(call) {
            activeCall = call;
            call.on('stream', r => { document.getElementById('remote-video').srcObject = r; });
            call.on('close', endCallUI);
        }
        
        // FIX: Updated endCall logic to ensure UI update on both sides
        function endCall() { 
            // 1. Send signal FIRST
            if(conn && conn.open) {
                conn.send({ type: 'call-end' }); 
            }
            
            // 2. Close local call object
            if (activeCall) {
                activeCall.close();
            }
            
            // 3. Update local UI immediately
            endCallUI(); 
        }

        // FIX: Improved endCallUI to fully reset state
        function endCallUI() {
            stopCallAlert(); // ENSURE RINGTONE STOPS
            document.getElementById('active-call-ui').style.display = 'none';
            document.getElementById('incoming-call-ui').style.display = 'none';
            
            // Clean up local tracks
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            
            activeCall = null;
            window.pendingCall = null;
        }

        function toggleMic() { const t = localStream.getAudioTracks()[0]; t.enabled = !t.enabled; document.getElementById('btn-mute').classList.toggle('off'); }
        function toggleCam() { const t = localStream.getVideoTracks()[0]; if (t) { t.enabled = !t.enabled; document.getElementById('btn-cam').classList.toggle('off'); } }
        
        // MODIFIED: rejectCall now notifies the caller
        function rejectCall() {
            stopCallAlert(); // STOP RINGTONE
            
            // Notify the caller that call is rejected
            if(conn && conn.open) {
                conn.send({ type: 'call-rejected' });
            }

            document.getElementById('incoming-call-ui').style.display = 'none'; 
            if(window.pendingCall) window.pendingCall.close();
            window.pendingCall = null;
        }

        let qrScanner;
        function startScanner() {
            document.getElementById('scanner-overlay').style.display = 'flex';
            
            // FIX: Safely create scanner
            if (!qrScanner) {
                qrScanner = new Html5Qrcode("qr-reader");
            }
            
            /* MODIFIED SECTION: SCANNER CONFIG
               1. Created dynamicqrBoxSize to be 70% of screen min-dimension (Solves "too close" issue).
               2. Added aspectRatio: 1.0 to reduce wide-angle distortion.
            */
            const qrBoxSize = Math.min(window.innerWidth, window.innerHeight) * 0.7;

            // FIX: Added catch block for camera errors
            qrScanner.start(
                { facingMode: "environment" }, 
                { 
                    fps: 30, 
                    qrbox: { width: qrBoxSize, height: qrBoxSize },
                    aspectRatio: 1.0 
                }, 
                t => {
                // FIX: Handle different scanner results
                stopScanner();
                try {
                    let id = '';
                    if(t.includes('#')) {
                        id = t.split('#')[1];
                    } else {
                        id = t; // Assume raw ID if no hash
                    }
                    
                    if (id && id.length > 0) {
                        window.location.hash = id;
                        window.location.reload();
                    } else {
                        alert("Invalid QR Code");
                    }
                } catch(e) {
                    alert("Error parsing QR");
                }
            }).catch(err => {
                console.error("Error starting scanner", err);
                alert("Could not start camera. Please ensure you are on HTTPS and have granted permissions.");
                document.getElementById('scanner-overlay').style.display = 'none';
            });
        }

        // FIX: Safe Stop Scanner Logic
        function stopScanner() { 
            if (qrScanner && qrScanner.isScanning) {
                qrScanner.stop().then(() => { 
                    qrScanner.clear(); 
                    document.getElementById('scanner-overlay').style.display = 'none'; 
                    qrScanner = null; // Reset instance
                }).catch(err => {
                    console.error("Failed to stop scanner", err);
                    document.getElementById('scanner-overlay').style.display = 'none';
                });
            } else {
                document.getElementById('scanner-overlay').style.display = 'none';
            }
        }
    </script>
</body>
</html>
